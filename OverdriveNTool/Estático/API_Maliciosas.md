# **API Maliciosas**
---

Joder esto va a ser super divertido (>o<), tanto en el archivo [Pecheck.txt](https://github.com/5kidRo0t/Malware_Analysis/blob/main/OverdriveNTool/Est치tico/Pecheck.txt) como en la carpeta API se recogen
todas las llamadas a la API de Windows obtenidas con la herramienta Pecheck, aqu칤 voy a indicar cuales de esas
son de uso com칰n por los desarrolladores de malware y una breve descripci칩n de que hacen, pero esto no quiere decir que est칠n siendo usadas con fines maliciosos. **쮼MPESAMOS? >:)**

游녢游낕游녢游낕 [Conclusiones al final] 游녢游낕游녢游낕

---

| File Name | Hash SHA-256 |
| --------- | ------------ |
| OverdriveNTool.exe |ad1c82b1ba7df42a977f0c18275e368174187977882e82b1deec6d33c55357a3 |

---

**[ advapi32.dll.AdjustTokenPrivileges ]**

- Se utiliza para permitir o bloquear determinados privilegios espec칤ficos de acceso. Las muestras de malware
que se inyectan en proceso suelen llamar a esta funci칩n para obtener permisos adicionales.

**[ gdi32.dll.BitBlt ]**

- Realiza una transferencia bit-block del color correspondiente a un rect치ngulo de p칤xeles del dispositivo fuente especificado.
Utilizada para copiar datos gr치ficos de un dispositivo a otro. Hay muestras de spyware que utilizan esta funci칩n para realizar
capturas de pantalla. Esta funci칩n suele ser a침adida por el compilador como parte del codigo de la librer칤a.

**[ user32.dll.CallNextHookEx ]**

- Utilizada por c칩digo que est치 hooke치ndose en un evento establecido por SetWindowsHookEx. Llama al siguiente hook en la cadena.
Analiza la funcion que la llama para determinar el prop칩sito del hook establecido por SetWindowsHookEx.

**[ Crypt32.dll.CertOpenSystemStore ]**

- Utilizada para acceder a los certificados almacenados en el sistema local.

**[ ole32.dll.CoCreateInstance ]**

- Crea un objeto COM. Los objetos COM permiten una gran cantidad de opciones. El identificador de clase CLSID indica que el
fichero contiene c칩digo que implementa el objeto COM.

**[ kernel32.dll.CreateFile ]**

- Crea un nuevo fichero o abre uno existente.

**[ kernel32.dll.CreateMutex ]**

- Crea un objeto de exclusi칩n mutua (mutex) que puede ser utilizado por el malware para asegurar que solo una 칰nica instancia del 
malware se est치 ejecutando en un momento dado. Es frecuente que el nombre del mutex est칠 hardcodeado en el malware, lo que puede
ser usado como IOC (Indicador de compromiso).

**[ kernel32.dll.CreateProcess ]**

- Crea y lanza un nuevo proceso.

**[ kernel32.dll.DeviceIoControl ]**

- Env칤a un mensaje de control del espacio usuario al driver del dispositivo. Suele ser usada por los malware dev por ser un modo
f치cil y flexible de pasar informaci칩n entre el espacio usuario y el espacio del kernel. Para entender mejor esto debemos entender
que Windows en este caso, separa en memoria una parte para su uso del kernel y otra para el usuario, estas no deben mezclarse.

**[ kernel32.dll.FindFirstFile/FindNextFile ]**

- Utilizada para buscar a trav칠s de un directorio y listar el sistema de ficheros.

**[ kernel32.dll.FindResource ]**

- Utilizada para encontrar un recurso en un ejecutable o librer칤a cargada. En ocasiones, el malware emplea recursos para
almacenar cadenas, informaci칩n de configuraci칩n u otros ficheros maliciosos. Como hemos detectado esta funci칩n debemos comprobar
la secci칩n .rsrc en la cabecera PE del malware, esto lo podremos ver con IDA Pro, Ghidra, PEStudio o PeiD... ya lo veremos m치s
adelante. (;

![ima](https://github.com/5kidRo0t/Malware_Analysis/assets/137389975/fa1cf48c-0e90-4e24-933d-b5d4dad3ef4a)

**[ user32.dll.FindWindow ]**

- Busca una ventana abierta en el escritorio. En ocasiones, esta funci칩n se utiliza como t칠cnica anti-debuggin para detectar
la presencia de un debugger, de hecho podemos encontrar la funci칩n IsDebuggerPresent en los archivos [kernel32.txt](https://github.com/5kidRo0t/Malware_Analysis/blob/main/OverdriveNTool/Est치tico/API/kernel32.txt) y [Pecheck.txt](https://github.com/5kidRo0t/Malware_Analysis/blob/main/OverdriveNTool/Est치tico/Pecheck.txt) esto es un claro indicativo de que tenemos presentes t칠cnicas anti-debugging que dificultan el an치lisis.

**[ user32.dll.GetDC ]**

- Devuelve un handle al contexto de un dispositivo (DC, Device Context) para una ventana o toda la pantalla. Las variantes de 
spyware que capturan pantallas suelen utilizar esta funci칩n.

**[ user32.dll.GetForegroundWindow ]**

- Devuelve un handle a la ventana que se encuentra en primer plano del escritorio. Utilizada habitualmente por los keyloggers
para determinar qu칠 ventana est치 introduciendo el usuario las pulsaciones del teclado.

**[ user32.dll.GetKeyState ]**

- Utilizada por keyloggers para obtener el estado de una tecla concreta del teclado.

**[ kernel32.dll.GetModuleFileName ]**

- Devuelve el nombre de fichero de un m칩dulo que est치 cargado en el proceso actual. El malware puede emplear esta funci칩n
para modificar o copiar ficheros en el proceso actualmente en ejecuci칩n.

**[ kernel32.dll.GetModuleHandle ]**

-  Utilizada para obtener un handle a un m칩dulo ya cargado. El malware puede utilizar esta funci칩n para localizar y modificar
c칩digo de un m칩dulo cargado o buscar una buena ubicaci칩n donde inyectar c칩digo.

**[ kernel32.dll.GetProcAddress ]**

- Recupera la direcci칩n de una funci칩n de una librer칤a cargada en memoria. Utilizada para importar funciones de otras 
librer칤as adem치s de funciones importadas en la cabecera del fichero PE.

**[ kernel32.dll.GetSystemDefaultUILanguage ]**

- Recupera el idioma establecido por defecto en la configuraci칩n del sistema. Habitualmente usado por malware que afecta 
칰nicamente a sistemas de determinadas regiones, o para customizar las pantallas y los nombres de fichero.

**[ kernel32.dll.GetTickCount ]**

- Recupera el n칰mero de milisegundos desde que el sistema se inici칩 (hasta un total de 49,7 d칤as). Esta funci칩n puede ser
utilizada para capturar informaci칩n del reloj del sistema y empleada como t칠cnica anti-debugging. Suele ser a침adida por el
compilador y se incluye en muchos ejecutables, por lo tanto no es un buen indicador de que el fichero sea malicioso, pero por lo que llevamos visto pues... (/>.<)/

**[ kernel32.dll.GetVersionEx ]**

- Devuelve informaci칩n de que versi칩n de Mocosoft Windows se est치 ejecutando. Puede ser empleada para obtener informaci칩n del
sistema o para seleccionar entre diferentes offsets de estructuras no documentadas que han cambiado entre diferentes versiones
de Mocosoft Windows.

**[ kernel32.dll.GetWindowsDirectory ]**

- Devuelve la ruta del directorio del sistema operativo (Ej. C:\Windows). Esta funci칩n puede ser utilizada por el malware
para determinar en qu칠 directorio instalar programas maliciosos adicionales.

**[ kernel32.dll.IsDebuggerPresent ]**

- Esta es bastante obvia, lo que hace es comprobar si el proceso actual est치 siendo depurado, es usado como t칠cnica 
anti-debugging y est치 presente en muchos ejecutables, es normal que los desarrolladores quieran proteger su software por lo 
tanto esta y otras t칠cnicas son de uso com칰n en software leg칤timo.

**[ kernel32.dll.IsWow64Process ]**

- Utilizada por un proceso de 32 bits para determinar si se est치 ejecutando en un sistema operativo de 64 bits.

**[ kernel32.dll.LoadLibrary ]**

- Carga una librer칤a en un proceso que pudiera no haberse cargado cuando el programa comenz칩. Importada por casi todos los 
programas Win32.

**[ kernel32.dll.LoadResource ]**

- Carga un recurso de un fichero PE en memoria. El malware en ocasiones utiliza recursos para almacenar cadenas, informaci칩n
de configuraci칩n u otros ficheros maliciosos.

**[ user32.dll.MapVirtualKey ]**

-  Mapea un c칩digo de tecla virtual en el valor de un car치cter o un c칩digo de escaneo. Tambi칠n puede mapear un c칩digo de escaneo
en una tecla virtual. Utilizada habitualmente por keyloggers.

**[ ole32.dll.OleInitialize ]**

- Utilizada para inicializar la librer칤a COM. Los programas que utilizan objetos COM deben llamar a esta funci칩n antes de llamar
a cualquier funci칩n COM.

**[ kernel32.dll.OpenMutex ]**

- Abre un handle a un mutex, lo que puede ser utilizado por el malware para asegurar que solo una 칰nica instancia de dicho
malware se encuentra en ejecuci칩n en ese momento en el sistema.

**[ kernel32.dll.OpenProcess ]**

- Abre un handle a otro proceso en ejecuci칩n en el sistema. Este handle puede ser utilizado para leer y escribir en la memoria
del otro proceso o para inyectar c칩digo dentro del otro proceso.

**[ kernel32.dll.OutputDebugString ]**

- Devuelve una cadena a un depurador si se le ha incorporado uno. Usado como anti-debugging.

**[ kernel32.dll.QueryPerformanceCounter ]**

- Utilizada para recuperar el valor del contador de rendimiento basado en hardware. Puede ser usada para recopilar informaci칩n
del reloj del sistema como parte de una t칠cnica anti-debugging.

**[ advapi32.dll.RegOpenKeyEx ]**

- Abre un handle a una clave de registro para su lectura y edici칩n. Las claves de registro son en ocasiones escritas por el
malware para lograr persistencia en el sistema.

**[ kernel32.dll.ResumeThread ]**

- Resume un hilo previamente suspendido. Se usa como parte de diferentes t칠cnicas de inyecci칩n.

**[ kernel32.dll.SetFileTime ]**

- Modifica los MAC times de un fichero. Esto puede ser usado por el malware para ocultar su actividad.

**[ user32.dll.SetWindowsHookEx ]**

- Establece una funci칩n hook que pueda ser llamada siempre que se llame a un determinado evento. Frecuentemente usada por 
keyloggers y spyware, esta funci칩n tambi칠n permite f치cilmente cargar una librer칤a dentro de todos los procesos GUI del sistema.

**[ shell32.dll.ShellExecute ]**

- Utilizada para ejecutar otro programa.

**[ kernel32.dll.VirtualAlloc ]**

- Rutina para asignaci칩n de memoria que permite asignar memoria en un proceso remoto. Puede ser usada para inyectar c칩digo.

**[ kernel32.dll.VirtualProtect ]**

- Cambia la protecci칩n de una regi칩n de memoria. El malware puede emplear esta funci칩n para cambiar una secci칩n de solo lectura de la memoria de un ejecutable.

**[ kernel32.dll.WideCharToMultiByte ]**

- Utilizada para convertir una cadena Unicode en una cadena ASCII.

---

# Conclusi칩n:

-Si esto no es un spyware entonces es un puto milagro, si hab칠is le칤do todas las funciones aqu칤 presentes podemos ver claramente un comportamiento t칤pico de un spyware, es raro que usen **[winhttp.dll]** que es lo que parece usarse para el env칤o de informaci칩n entre la v칤ctima y el atacante, digo es raro porque generalmente se usa **[wininet.dll]** debido a que ofrece un espectro m치s amplio en un contexto comunicativo. 


No he explicado aqu칤 ninguna funci칩n dentro de winhttp para no extenderme m치s y porque realmente es innecesario, con que sepamos que las funciones que ya hemos visto y detectado en el primer an치lisis est치tico del ejecutable en su conjunto muestran un claro comportamiento de un spyware y que **winhttp** es usado para el intercambio de informaci칩n es m치s que suficiente, adem치s que sepamos que **winhttp** est치 presente es un adelantamiento a que cuando hagamos el an치lisis din치mico del comportamiento en red debemos centrarnos en el protocolo http. 


Me sorprendi칩 gratamente que QualiaSG qui칠n me indic칩 este contenido para su an치lisis mencionase que esto pod칤a ser un *Keylogger* o *Spyware*, yo me decanto por un *Troyano/Spyware* con funciones de *keylogger* por lo que hemos visto hasta ahora.


Con esto podr칤amos decir que hemos finalizado casi el an치lisis est치tico porque las funciones usadas por una aplicaci칩n arrojan much칤sima informaci칩n, ir칠 subiendo m치s cositas sobre el an치lisis est치tico porque a칰n nos queda ver los **.bin** pero ya no creo que vaya a ser tan explicativo, mas que nada porque por ejemplo los strings, pues joder son cadenas de texto que se han obtenido de la muestra por lo tanto no tengo nada que explicar ah칤. *Arigatooo (0~0)/*
